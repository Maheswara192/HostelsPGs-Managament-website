[{"filePath":"C:\\Users\\mahis\\OneDrive\\Desktop\\Hostels\\client\\src\\pages\\tenant\\Payments.jsx","messages":[{"ruleId":"react-hooks/immutability","severity":2,"message":"Error: Cannot access variable before it is declared\n\n`fetchPayments` is accessed before it is declared, which prevents the earlier access from updating when this value changes over time.\n\n  12 |\n  13 |     useEffect(() => {\n> 14 |         fetchPayments();\n     |         ^^^^^^^^^^^^^ `fetchPayments` accessed before it is declared\n  15 |     }, []);\n  16 |\n  17 |     const fetchPayments = async () => {\n\n  15 |     }, []);\n  16 |\n> 17 |     const fetchPayments = async () => {\n     |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 18 |         try {\n     | ^^^^^^^^^^^^^\n> 19 |             const res = await tenantService.getPayments();\n     â€¦\n     | ^^^^^^^^^^^^^\n> 26 |         }\n     | ^^^^^^^^^^^^^\n> 27 |     };\n     | ^^^^^^^ `fetchPayments` is declared here\n  28 |\n  29 |     const handlePayRent = async () => {\n  30 |         setLoading(true);","line":14,"column":9,"nodeType":null,"endLine":14,"endColumn":22}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport tenantService from '../../services/tenant.service';\r\n\r\n// Load Razorpay Script dynamically if not present in index.html, \r\n// usually it's better to have it in index.html <script src=\"https://checkout.razorpay.com/v1/checkout.js\"></script>\r\n// We assume it is available as window.Razorpay\r\n\r\nconst Payments = () => {\r\n    const [rentAmount, setRentAmount] = useState(0);\r\n    const [payments, setPayments] = useState([]);\r\n    const [loading, setLoading] = useState(false);\r\n\r\n    useEffect(() => {\r\n        fetchPayments();\r\n    }, []);\r\n\r\n    const fetchPayments = async () => {\r\n        try {\r\n            const res = await tenantService.getPayments();\r\n            if (res.success) {\r\n                setRentAmount(res.data.rentAmount);\r\n                setPayments(res.data.payments);\r\n            }\r\n        } catch (error) {\r\n            console.error('Error fetching payments:', error);\r\n        }\r\n    };\r\n\r\n    const handlePayRent = async () => {\r\n        setLoading(true);\r\n        try {\r\n            const res = await tenantService.initiateRentPayment();\r\n\r\n            if (res.success) {\r\n                const options = {\r\n                    key: res.key_id,\r\n                    amount: res.amount,\r\n                    currency: \"INR\",\r\n                    name: \"Hostel Rent Payment\",\r\n                    description: \"Monthly Rent\",\r\n                    order_id: res.order_id,\r\n                    handler: async function (response) {\r\n                        try {\r\n                            const verifyRes = await tenantService.verifyPayment({\r\n                                razorpay_order_id: response.razorpay_order_id,\r\n                                razorpay_payment_id: response.razorpay_payment_id,\r\n                                razorpay_signature: response.razorpay_signature\r\n                            });\r\n                            if (verifyRes.success) {\r\n                                alert('Payment Successful!');\r\n                                fetchPayments();\r\n                            } else {\r\n                                alert('Payment Verification Failed');\r\n                            }\r\n                        } catch (err) {\r\n                            console.error(err);\r\n                            alert('Payment Verification Error');\r\n                        }\r\n                    },\r\n                    prefill: {\r\n                        name: \"Tenant\", // Ideally get from user context\r\n                        email: \"tenant@example.com\",\r\n                        contact: \"\"\r\n                    },\r\n                    theme: {\r\n                        color: \"#3399cc\"\r\n                    }\r\n                };\r\n\r\n                // MOCK MODE DETECTION\r\n                if (res.key_id.startsWith('mock_') || res.key_id === 'rzp_test_missing') {\r\n                    if (window.confirm(\"DEV MODE: Simulate Successful Payment?\")) {\r\n                        // Simulate delay\r\n                        setTimeout(async () => {\r\n                            // Call Handler with Mock Response\r\n                            options.handler({\r\n                                razorpay_order_id: res.order_id,\r\n                                razorpay_payment_id: 'pay_mock_' + Date.now(),\r\n                                razorpay_signature: 'mock_signature' // Service will accept this because key is mock\r\n                            });\r\n                        }, 1000);\r\n                        return;\r\n                    } else {\r\n                        return; // User cancelled simulation\r\n                    }\r\n                }\r\n\r\n                const rzp1 = new window.Razorpay(options);\r\n                rzp1.on('payment.failed', function (response) {\r\n                    alert(`Payment Failed: ${response.error.description}`);\r\n                    setLoading(false);\r\n                });\r\n                rzp1.open();\r\n            } else {\r\n                alert('Failed to initiate payment');\r\n                setLoading(false);\r\n            }\r\n        } catch (error) {\r\n            console.error('Payment Error:', error);\r\n            alert('Something went wrong. Please try again.');\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div className=\"p-6 relative\">\r\n            <h1 className=\"text-2xl font-bold text-slate-800 mb-6\">Payments & Rent</h1>\r\n\r\n            {/* Processing Overlay */}\r\n            {loading && (\r\n                <div className=\"absolute inset-0 bg-white/80 z-50 flex flex-col items-center justify-center rounded-lg\">\r\n                    <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mb-4\"></div>\r\n                    <p className=\"text-lg font-semibold text-slate-700\">Processing Payment...</p>\r\n                    <p className=\"text-sm text-slate-500\">Please do not close this window.</p>\r\n                </div>\r\n            )}\r\n\r\n            {/* Pay Rent Section */}\r\n            <div className=\"bg-white p-6 rounded-lg shadow-md border border-slate-200 mb-8 flex justify-between items-center transition-all hover:shadow-lg\">\r\n                <div>\r\n                    <p className=\"text-slate-600 mb-1\">Current Monthly Rent</p>\r\n                    <h2 className=\"text-3xl font-bold text-slate-900\">â‚¹{rentAmount}</h2>\r\n                </div>\r\n                <div className=\"flex flex-col gap-2\">\r\n                    <button\r\n                        onClick={handlePayRent}\r\n                        disabled={loading || rentAmount <= 0}\r\n                        className=\"bg-emerald-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-emerald-700 shadow-sm disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2\"\r\n                    >\r\n                        <span>ðŸ’³</span> {loading ? 'Processing...' : 'Pay Rent Now'}\r\n                    </button>\r\n                    {rentAmount > 0 && <span className=\"text-xs text-slate-500 text-center\">Secured by Razorpay</span>}\r\n                </div>\r\n            </div>\r\n\r\n            {/* Payment History */}\r\n            <div className=\"bg-white p-6 rounded-lg shadow-md border border-slate-200\">\r\n                <div className=\"flex justify-between items-center mb-4\">\r\n                    <h2 className=\"text-xl font-semibold\">payment History</h2>\r\n                    <button onClick={fetchPayments} className=\"text-sm text-indigo-600 hover:underline\">Refresh</button>\r\n                </div>\r\n                <div className=\"overflow-x-auto\">\r\n                    <table className=\"w-full text-left border-collapse\">\r\n                        <thead>\r\n                            <tr className=\"bg-slate-50 border-b\">\r\n                                <th className=\"p-3 text-slate-600 font-medium\">Date</th>\r\n                                <th className=\"p-3 text-slate-600 font-medium\">Amount</th>\r\n                                <th className=\"p-3 text-slate-600 font-medium\">Type</th>\r\n                                <th className=\"p-3 text-slate-600 font-medium\">Status</th>\r\n                                <th className=\"p-3 text-slate-600 font-medium\">Reference ID</th>\r\n                            </tr>\r\n                        </thead>\r\n                        <tbody>\r\n                            {payments.length === 0 ? (\r\n                                <tr>\r\n                                    <td colSpan=\"5\" className=\"p-8 text-center text-slate-500 italic\">No payment history available.</td>\r\n                                </tr>\r\n                            ) : (\r\n                                payments.map((pay) => (\r\n                                    <tr key={pay._id} className=\"border-b hover:bg-slate-50 transition-colors\">\r\n                                        <td className=\"p-3 text-slate-800\">{new Date(pay.transaction_date).toLocaleDateString()}</td>\r\n                                        <td className=\"p-3 text-slate-800 font-semibold\">â‚¹{pay.amount}</td>\r\n                                        <td className=\"p-3 text-slate-600 text-sm\">{pay.type}</td>\r\n                                        <td className=\"p-3\">\r\n                                            <span className={`px-2 py-1 rounded-full text-xs font-bold border \r\n                                                ${pay.status === 'SUCCESS' ? 'bg-green-50 text-green-700 border-green-200' :\r\n                                                    pay.status === 'FAILED' ? 'bg-red-50 text-red-700 border-red-200' :\r\n                                                        'bg-yellow-50 text-yellow-700 border-yellow-200'}`}>\r\n                                                {pay.status}\r\n                                            </span>\r\n                                        </td>\r\n                                        <td className=\"p-3 text-xs text-slate-400 font-mono tracking-wide\">{pay.gateway_order_id}</td>\r\n                                    </tr>\r\n                                ))\r\n                            )}\r\n                        </tbody>\r\n                    </table>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default Payments;\r\n","usedDeprecatedRules":[]}]
